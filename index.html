<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æˆ‘ä»¬çš„ç•™è¨€æ¿ â¤ï¸</title>
  <style>
    body {
      background-color: #FFF8E7;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      color: #333;
      padding: 20px;
      margin: 0;
    }

    h1 {
      color: #FFC0CB;
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .subtitle {
      text-align: center;
      color: #ff99aa;
      font-size: 1.2em;
      margin-bottom: 30px;
    }

    /* å¯¼èˆªæ æ ·å¼ */
    .nav-container {
      background-color: #FFF0F5;
      border: 2px solid #FFC0CB;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      max-width: 800px;
      box-shadow: 0 4px 10px rgba(255, 182, 193, 0.3);
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .nav-tab {
      padding: 12px 20px;
      background-color: #FFF8E7;
      border: 2px solid #FFC0CB;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      font-size: 1em;
      color: #333;
    }

    .nav-tab:hover {
      background-color: #FFE4E1;
      transform: translateY(-2px);
    }

    .nav-tab.active {
      background-color: #FFC0CB;
      color: white;
      box-shadow: 0 4px 10px rgba(255, 182, 193, 0.5);
    }

    /* è¡¨å•æ ·å¼ */
    form {
      margin: 30px auto;
      text-align: center;
      max-width: 600px;
      background-color: #FFF0F5;
      padding: 25px;
      border-radius: 15px;
      border: 2px solid #FFC0CB;
      box-shadow: 0 4px 10px rgba(255, 182, 193, 0.3);
    }

    input, textarea {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      border: 2px solid #FFC0CB;
      border-radius: 10px;
      background-color: #FFF8E7;
      font-size: 1em;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #ff99aa;
      background-color: #FFF0F5;
    }

    button {
      padding: 10px 20px;
      background-color: #FFC0CB;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 1em;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }

    button:hover {
      background-color: #ff99aa;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* æ¶ˆæ¯åˆ—è¡¨æ ·å¼ */
    .messages-section {
      max-width: 800px;
      margin: 0 auto;
    }

    .section-title {
      text-align: center;
      color: #FFC0CB;
      font-size: 1.8em;
      margin: 30px 0 20px 0;
      padding: 10px;
      background-color: #FFF0F5;
      border-radius: 10px;
      border: 2px solid #FFC0CB;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      background-color: #FFF0F5;
      margin: 10px auto;
      padding: 15px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 2px 5px rgba(255, 182, 193, 0.3);
      font-size: 1em;
    }

    .message-meta {
      font-size: 0.9em;
      color: #ff99aa;
      margin-bottom: 8px;
    }

    .message-content {
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .delete-btn {
      background-color: #FFB6C1;
      font-size: 0.9em;
      padding: 5px 10px;
    }

    .delete-btn:hover {
      background-color: #FFA0B4;
    }

    /* åˆ†é¡µæ ·å¼ */
    .pagination {
      text-align: center;
      margin: 20px 0;
    }

    .pagination button {
      margin: 0 10px;
    }

    /* çŠ¶æ€æç¤º */
    .loading, .error, .empty {
      text-align: center;
      padding: 30px;
      color: #ff99aa;
      font-size: 1.1em;
    }

    .error {
      color: #FF6B6B;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .nav-tabs {
        flex-direction: column;
        align-items: center;
      }
      
      .nav-tab {
        width: 200px;
        margin: 5px 0;
      }
      
      input, textarea {
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <h1>æˆ‘ä»¬çš„ç•™è¨€æ¿ â¤ï¸</h1>
  <div class="subtitle">åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œè®°å½•ç¾å¥½æ—¶å…‰</div>

  <!-- å¯¼èˆªæ  -->
  <div class="nav-container">
    <div class="nav-tabs">
      <button class="nav-tab active" data-category="chat">ğŸ’¬ é—²èŠåŒº</button>
      <button class="nav-tab" data-category="dreams">âœ¨ æ¢¦å¢ƒé›†</button>
      <button class="nav-tab" data-category="work">ğŸ’¼ å·¥ä½œé—´</button>
      <button class="nav-tab" data-category="media">ğŸµ å½±éŸ³è§’</button>
    </div>
  </div>

  <!-- è¾“å…¥è¡¨å• -->
  <form id="messageForm">
    <input type="text" id="nameInput" placeholder="æ˜µç§°" required>
    <textarea id="messageInput" placeholder="å†™ä¸‹ä½ çš„ç•™è¨€..." required></textarea>
    <button type="submit" id="submitBtn">å‘é€</button>
  </form>

  <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
  <div class="messages-section">
    <h2 class="section-title">ğŸ’¬ é—²èŠåŒº</h2>
    <ul id="messageList">
      <li class="loading">åŠ è½½ä¸­...</li>
    </ul>
  </div>

  <!-- åˆ†é¡µæ§ä»¶ -->
  <div class="pagination">
    <button id="prevPage">ä¸Šä¸€é¡µ</button>
    <button id="nextPage">ä¸‹ä¸€é¡µ</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, limit, startAfter, endBefore, getDocs,
      deleteDoc, doc as docRef, where, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyBxH-cnv7jtJRuzhvBHRZVBNyXXG9dvdwM",
      authDomain: "message-board-6ccb5.firebaseapp.com",
      projectId: "message-board-6ccb5",
      storageBucket: "message-board-6ccb5.appspot.com",
      messagingSenderId: "860538002965",
      appId: "1:860538002965:web:9bb3382be721f7c4bb781c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const messagesRef = collection(db, "messages");

    // DOM å…ƒç´ 
    const form = document.getElementById("messageForm");
    const nameInput = document.getElementById("nameInput");
    const messageInput = document.getElementById("messageInput");
    const submitBtn = document.getElementById("submitBtn");
    const list = document.getElementById("messageList");
    const sectionTitle = document.querySelector(".section-title");
    const navTabs = document.querySelectorAll('.nav-tab');
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");

    // å…¨å±€å˜é‡
    let currentCategory = 'chat';
    let pageSize = 20;
    let lastVisible = null;
    let firstVisible = null;
    let currentDocs = [];
    let isLoading = false;

    const categoryNames = {
      'chat': 'ğŸ’¬ é—²èŠåŒº',
      'dreams': 'âœ¨ æ¢¦å¢ƒé›†',
      'work': 'ğŸ’¼ å·¥ä½œé—´',
      'media': 'ğŸµ å½±éŸ³è§’'
    };

    // å¯¼èˆªæ åˆ‡æ¢
    navTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        if (isLoading) return;
        
        // æ›´æ–°å¯¼èˆªæ çŠ¶æ€
        navTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // æ›´æ–°å½“å‰åˆ†ç±»
        currentCategory = tab.dataset.category;
        sectionTitle.textContent = categoryNames[currentCategory];
        
        // é‡ç½®åˆ†é¡µçŠ¶æ€
        resetPagination();
        
        // åŠ è½½å¯¹åº”åˆ†ç±»çš„æ¶ˆæ¯
        loadMessages();
      });
    });

    // é‡ç½®åˆ†é¡µçŠ¶æ€
    function resetPagination() {
      lastVisible = null;
      firstVisible = null;
      currentDocs = [];
    }

    // åŠ è½½æ¶ˆæ¯å‡½æ•°
    async function loadMessages(direction = "initial") {
      if (isLoading) return;
      isLoading = true;
      
      try {
        list.innerHTML = '<li class="loading">åŠ è½½ä¸­...</li>';
        
        let q;
        
        if (direction === "next" && lastVisible) {
          q = query(messagesRef, orderBy("timestamp", "desc"), startAfter(lastVisible), limit(pageSize));
        } else if (direction === "prev" && firstVisible) {
          q = query(messagesRef, orderBy("timestamp", "desc"), endBefore(firstVisible), limit(pageSize));
        } else {
          q = query(messagesRef, orderBy("timestamp", "desc"), limit(pageSize));
        }

        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          list.innerHTML = `<li class="empty">æš‚æ— ç•™è¨€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼ ğŸ’•</li>`;
          updatePaginationButtons(false, false);
          return;
        }

        // è¿‡æ»¤æ¶ˆæ¯ï¼šæ ¹æ®å½“å‰åˆ†ç±»æ˜¾ç¤º
        const filteredDocs = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          // å¦‚æœæ˜¯é—²èŠåŒºï¼Œæ˜¾ç¤ºæ‰€æœ‰æ²¡æœ‰categoryæˆ–categoryä¸ºchatçš„æ¶ˆæ¯
          if (currentCategory === 'chat') {
            if (!data.category || data.category === 'chat') {
              filteredDocs.push(doc);
            }
          } else {
            // å…¶ä»–åˆ†ç±»åªæ˜¾ç¤ºå¯¹åº”çš„æ¶ˆæ¯
            if (data.category === currentCategory) {
              filteredDocs.push(doc);
            }
          }
        });

        list.innerHTML = "";
        currentDocs = filteredDocs;

        if (filteredDocs.length === 0) {
          list.innerHTML = `<li class="empty">æš‚æ— ç•™è¨€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼ ğŸ’•</li>`;
          updatePaginationButtons(false, false);
          return;
        }

        filteredDocs.forEach(doc => {
          const data = doc.data();
          const li = document.createElement("li");
          
          const timestamp = data.timestamp && data.timestamp.seconds ? 
            new Date(data.timestamp.seconds * 1000).toLocaleString() : 
            'æ—¶é—´æœªçŸ¥';
          
          li.innerHTML = `
            <div class="message-meta">
              <strong>${escapeHtml(data.name || 'åŒ¿å')}</strong> - ${timestamp}
            </div>
            <div class="message-content">${escapeHtml(data.message || '')}</div>
            <button data-id="${doc.id}" class="delete-btn">åˆ é™¤</button>
          `;
          list.appendChild(li);
        });

        // æ›´æ–°åˆ†é¡µçŠ¶æ€
        if (filteredDocs.length > 0) {
          firstVisible = filteredDocs[0];
          lastVisible = filteredDocs[filteredDocs.length - 1];
        }
        
        // æ›´æ–°åˆ†é¡µæŒ‰é’®
        updatePaginationButtons(direction !== "initial", filteredDocs.length === pageSize);

      } catch (error) {
        console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
        list.innerHTML = `<li class="error">åŠ è½½å¤±è´¥ï¼š${error.message}</li>`;
        updatePaginationButtons(false, false);
      } finally {
        isLoading = false;
      }
    }

    // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
    function updatePaginationButtons(hasPrev, hasNext) {
      prevPageBtn.disabled = !hasPrev;
      nextPageBtn.disabled = !hasNext;
    }

    // HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // å‘å¸ƒç•™è¨€
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const name = nameInput.value.trim();
      const message = messageInput.value.trim();
      
      if (!name || !message) {
        alert('è¯·å¡«å†™æ˜µç§°å’Œç•™è¨€å†…å®¹ï¼');
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'å‘é€ä¸­...';
      
      try {
        const docData = {
          name: name,
          message: message,
          timestamp: serverTimestamp()
        };
        
        // åªæœ‰éé—²èŠåŒºæ‰æ·»åŠ categoryå­—æ®µ
        if (currentCategory !== 'chat') {
          docData.category = currentCategory;
        }
        
        await addDoc(messagesRef, docData);
        
        nameInput.value = "";
        messageInput.value = "";
        
        // é‡æ–°åŠ è½½æ¶ˆæ¯
        resetPagination();
        loadMessages();
        
        console.log('ç•™è¨€å‘å¸ƒæˆåŠŸ');
        
      } catch (error) {
        console.error('å‘å¸ƒç•™è¨€å¤±è´¥:', error);
        alert('å‘å¸ƒå¤±è´¥ï¼š' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'å‘é€';
      }
    });

    // åˆ é™¤ç•™è¨€
    list.addEventListener("click", async (e) => {
      if (e.target.classList.contains("delete-btn")) {
        const id = e.target.dataset.id;
        if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ")) {
          try {
            await deleteDoc(docRef(db, "messages", id));
            loadMessages();
          } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
          }
        }
      }
    });

    // åˆ†é¡µæ§ä»¶
    nextPageBtn.addEventListener("click", () => {
      if (!isLoading && lastVisible) {
        loadMessages("next");
      }
    });

    prevPageBtn.addEventListener("click", () => {
      if (!isLoading && firstVisible) {
        loadMessages("prev");
      }
    });

    // åˆå§‹åŒ–åŠ è½½
    window.addEventListener('load', () => {
      console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åŠ è½½ç•™è¨€...');
      loadMessages();
    });

    // è°ƒè¯•ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    window.addEventListener('error', (e) => {
      console.error('é¡µé¢é”™è¯¯:', e.error);
    });
  </script>
</body>
</html>
