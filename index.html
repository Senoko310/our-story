<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æˆ‘ä»¬çš„ç•™è¨€æ¿ â¤ï¸</title>
  <style>
    body {
      background-color: #FFF8E7;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      color: #333;
      padding: 20px;
      margin: 0;
    }

    h1 {
      color: #FFC0CB;
      text-align: center;
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .subtitle {
      text-align: center;
      color: #ff99aa;
      font-size: 1.2em;
      margin-bottom: 30px;
    }

    /* å¯¼èˆªæ æ ·å¼ */
    .nav-container {
      background-color: #FFF0F5;
      border: 2px solid #FFC0CB;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      max-width: 800px;
      box-shadow: 0 4px 10px rgba(255, 182, 193, 0.3);
    }

    .nav-tabs {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .nav-tab {
      padding: 12px 20px;
      background-color: #FFF8E7;
      border: 2px solid #FFC0CB;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      font-size: 1em;
      color: #333;
    }

    .nav-tab:hover {
      background-color: #FFE4E1;
      transform: translateY(-2px);
    }

    .nav-tab.active {
      background-color: #FFC0CB;
      color: white;
      box-shadow: 0 4px 10px rgba(255, 182, 193, 0.5);
    }

    /* è¡¨å•æ ·å¼ */
    form {
      margin: 30px auto;
      text-align: center;
      max-width: 600px;
      background-color: #FFF0F5;
      padding: 25px;
      border-radius: 15px;
      border: 2px solid #FFC0CB;
      box-shadow: 0 4px 10px rgba(255, 182, 193, 0.3);
    }

    input, textarea {
      width: 90%;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #FFC0CB;
      border-radius: 10px;
      background-color: #FFF8E7;
      font-size: 1em;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      box-sizing: border-box;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #ff99aa;
      background-color: #FFF0F5;
    }

    button {
      padding: 12px 25px;
      background-color: #FFC0CB;
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 1em;
      font-family: 'Comic Sans MS', cursive, sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }

    button:hover {
      background-color: #ff99aa;
      transform: translateY(-2px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* æ¶ˆæ¯åˆ—è¡¨æ ·å¼ */
    .messages-section {
      max-width: 800px;
      margin: 0 auto;
    }

    .section-title {
      text-align: center;
      color: #FFC0CB;
      font-size: 1.8em;
      margin: 30px 0 20px 0;
      padding: 10px;
      background-color: #FFF0F5;
      border-radius: 10px;
      border: 2px solid #FFC0CB;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      background-color: #FFF0F5;
      margin: 15px auto;
      padding: 20px;
      border-radius: 15px;
      width: 95%;
      max-width: 750px;
      box-shadow: 0 4px 10px rgba(255, 182, 193, 0.3);
      font-size: 1em;
      border: 2px solid #FFE4E1;
      transition: transform 0.2s ease;
    }

    li:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(255, 182, 193, 0.4);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .message-author {
      font-weight: bold;
      color: #FFC0CB;
      font-size: 1.1em;
    }

    .message-time {
      color: #ff99aa;
      font-size: 0.9em;
    }

    .message-content {
      line-height: 1.6;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }

    .delete-btn {
      background-color: #FFB6C1;
      font-size: 0.9em;
      padding: 6px 12px;
    }

    .delete-btn:hover {
      background-color: #FFA0B4;
    }

    /* åˆ†é¡µæ ·å¼ */
    .pagination {
      text-align: center;
      margin: 30px 0;
      padding: 20px;
    }

    .pagination button {
      margin: 0 10px;
      padding: 10px 20px;
    }

    /* åŠ è½½å’Œé”™è¯¯çŠ¶æ€ */
    .loading, .error, .empty {
      text-align: center;
      padding: 40px;
      font-size: 1.1em;
      color: #ff99aa;
      background-color: #FFF0F5;
      border-radius: 10px;
      margin: 20px auto;
      max-width: 600px;
      border: 2px solid #FFE4E1;
    }

    .error {
      color: #FF6B6B;
      border-color: #FFB6C1;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .nav-tabs {
        flex-direction: column;
        align-items: center;
      }
      
      .nav-tab {
        width: 200px;
        margin: 5px 0;
      }
      
      input, textarea {
        width: 95%;
      }
      
      .message-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
    }
  </style>
</head>
<body>
  <h1>æˆ‘ä»¬çš„ç•™è¨€æ¿ â¤ï¸</h1>
  <div class="subtitle">åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œè®°å½•ç¾å¥½æ—¶å…‰</div>

  <!-- å¯¼èˆªæ  -->
  <div class="nav-container">
    <div class="nav-tabs">
      <button class="nav-tab active" data-category="chat">ğŸ’¬ é—²èŠåŒº</button>
      <button class="nav-tab" data-category="dreams">âœ¨ æ¢¦å¢ƒé›†</button>
      <button class="nav-tab" data-category="work">ğŸ’¼ å·¥ä½œé—´</button>
      <button class="nav-tab" data-category="media">ğŸµ å½±éŸ³è§’</button>
    </div>
  </div>

  <!-- è¾“å…¥è¡¨å• -->
  <form id="messageForm">
    <input type="text" id="nameInput" placeholder="è¾“å…¥ä½ çš„æ˜µç§°..." required maxlength="20">
    <textarea id="messageInput" placeholder="å†™ä¸‹ä½ çš„ç•™è¨€..." required maxlength="500" rows="4"></textarea>
    <button type="submit" id="submitBtn">å‘é€ç•™è¨€</button>
  </form>

  <!-- æ¶ˆæ¯æ˜¾ç¤ºåŒºåŸŸ -->
  <div class="messages-section">
    <h2 class="section-title">ğŸ’¬ é—²èŠåŒº</h2>
    <ul id="messageList">
      <li class="loading">åŠ è½½ä¸­...</li>
    </ul>
  </div>

  <!-- åˆ†é¡µæ§ä»¶ -->
  <div class="pagination">
    <button id="prevPage">ä¸Šä¸€é¡µ</button>
    <button id="nextPage">ä¸‹ä¸€é¡µ</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, limit, startAfter, endBefore, getDocs,
      deleteDoc, doc as docRef, where, writeBatch
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyBxH-cnv7jtJRuzhvBHRZVBNyXXG9dvdwM",
      authDomain: "message-board-6ccb5.firebaseapp.com",
      projectId: "message-board-6ccb5",
      storageBucket: "message-board-6ccb5.appspot.com",
      messagingSenderId: "860538002965",
      appId: "1:860538002965:web:9bb3382be721f7c4bb781c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const messagesRef = collection(db, "messages");

    // DOM å…ƒç´ 
    const form = document.getElementById("messageForm");
    const nameInput = document.getElementById("nameInput");
    const messageInput = document.getElementById("messageInput");
    const submitBtn = document.getElementById("submitBtn");
    const list = document.getElementById("messageList");
    const sectionTitle = document.querySelector(".section-title");
    const navTabs = document.querySelectorAll('.nav-tab');
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");

    // å…¨å±€å˜é‡
    let currentCategory = 'chat';
    let pageSize = 20;
    let lastVisible = null;
    let firstVisible = null;
    let currentDocs = [];
    let isLoading = false;

    const categoryNames = {
      'chat': 'ğŸ’¬ é—²èŠåŒº',
      'dreams': 'âœ¨ æ¢¦å¢ƒé›†',
      'work': 'ğŸ’¼ å·¥ä½œé—´',
      'media': 'ğŸµ å½±éŸ³è§’'
    };

    // å¯¼èˆªæ åˆ‡æ¢
    navTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        if (isLoading) return;
        
        // æ›´æ–°å¯¼èˆªæ çŠ¶æ€
        navTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // æ›´æ–°å½“å‰åˆ†ç±»
        currentCategory = tab.dataset.category;
        sectionTitle.textContent = categoryNames[currentCategory];
        
        // é‡ç½®åˆ†é¡µçŠ¶æ€
        lastVisible = null;
        firstVisible = null;
        currentDocs = [];
        
        // åŠ è½½å¯¹åº”åˆ†ç±»çš„æ¶ˆæ¯
        loadMessages();
      });
    });

    // åŠ è½½æ¶ˆæ¯å‡½æ•°
    async function loadMessages(direction = "initial") {
      if (isLoading) return;
      isLoading = true;
      
      try {
        list.innerHTML = '<li class="loading">åŠ è½½ä¸­...</li>';
        
        let q;
        
        // æ„å»ºæŸ¥è¯¢æ¡ä»¶
        if (currentCategory === 'chat') {
          // é—²èŠåŒºï¼šæ˜¾ç¤ºæ‰€æœ‰æ²¡æœ‰åˆ†ç±»çš„æ—§æ¶ˆæ¯ + æ–°çš„é—²èŠæ¶ˆæ¯
          if (direction === "next" && lastVisible) {
            q = query(messagesRef, 
              where('category', 'in', ['chat', null]), 
              orderBy("timestamp", "desc"), 
              startAfter(lastVisible), 
              limit(pageSize)
            );
          } else if (direction === "prev" && firstVisible) {
            q = query(messagesRef, 
              where('category', 'in', ['chat', null]), 
              orderBy("timestamp", "desc"), 
              endBefore(firstVisible), 
              limit(pageSize)
            );
          } else {
            q = query(messagesRef, 
              where('category', 'in', ['chat', null]), 
              orderBy("timestamp", "desc"), 
              limit(pageSize)
            );
          }
        } else {
          // å…¶ä»–åˆ†ç±»ï¼šåªæ˜¾ç¤ºå¯¹åº”åˆ†ç±»çš„æ¶ˆæ¯
          if (direction === "next" && lastVisible) {
            q = query(messagesRef, 
              where('category', '==', currentCategory), 
              orderBy("timestamp", "desc"), 
              startAfter(lastVisible), 
              limit(pageSize)
            );
          } else if (direction === "prev" && firstVisible) {
            q = query(messagesRef, 
              where('category', '==', currentCategory), 
              orderBy("timestamp", "desc"), 
              endBefore(firstVisible), 
              limit(pageSize)
            );
          } else {
            q = query(messagesRef, 
              where('category', '==', currentCategory), 
              orderBy("timestamp", "desc"), 
              limit(pageSize)
            );
          }
        }

        const snapshot = await getDocs(q);
        list.innerHTML = "";
        currentDocs = [];

        if (snapshot.empty) {
          list.innerHTML = `
            <li class="empty">
              <div>æš‚æ— ç•™è¨€ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€æ¡å§ï¼ ğŸ’•</div>
            </li>
          `;
          updatePaginationButtons(false, false);
          return;
        }

        snapshot.forEach(doc => {
          currentDocs.push(doc);
          const data = doc.data();
          const li = document.createElement("li");
          
          const timestamp = data.timestamp?.seconds ? 
            new Date(data.timestamp.seconds * 1000).toLocaleString('zh-CN') : 
            'æ—¶é—´æœªçŸ¥';
          
          li.innerHTML = `
            <div class="message-header">
              <span class="message-author">${escapeHtml(data.name || 'åŒ¿å')}</span>
              <span class="message-time">${timestamp}</span>
            </div>
            <div class="message-content">${escapeHtml(data.message || '')}</div>
            <button data-id="${doc.id}" class="delete-btn">åˆ é™¤</button>
          `;
          list.appendChild(li);
        });

        // æ›´æ–°åˆ†é¡µçŠ¶æ€
        firstVisible = currentDocs[0];
        lastVisible = currentDocs[currentDocs.length - 1];
        
        // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
        updatePaginationButtons(true, currentDocs.length === pageSize);

      } catch (error) {
        console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
        list.innerHTML = `
          <li class="error">
            <div>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯• ğŸ˜¢</div>
          </li>
        `;
        updatePaginationButtons(false, false);
      } finally {
        isLoading = false;
      }
    }

    // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
    function updatePaginationButtons(hasPrev, hasNext) {
      prevPageBtn.disabled = !hasPrev || !firstVisible;
      nextPageBtn.disabled = !hasNext || !lastVisible;
    }

    // HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // å‘å¸ƒç•™è¨€
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const name = nameInput.value.trim();
      const message = messageInput.value.trim();
      
      if (!name || !message) {
        alert('è¯·å¡«å†™æ˜µç§°å’Œç•™è¨€å†…å®¹ï¼');
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.textContent = 'å‘é€ä¸­...';
      
      try {
        await addDoc(messagesRef, {
          name: name,
          message: message,
          timestamp: serverTimestamp(),
          category: currentCategory,
          createdAt: new Date().toISOString()
        });
        
        nameInput.value = "";
        messageInput.value = "";
        
        // é‡æ–°åŠ è½½å½“å‰åˆ†ç±»çš„æ¶ˆæ¯
        lastVisible = null;
        firstVisible = null;
        currentDocs = [];
        loadMessages();
        
      } catch (error) {
        console.error('å‘å¸ƒç•™è¨€å¤±è´¥:', error);
        alert('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'å‘é€ç•™è¨€';
      }
    });

    // åˆ é™¤ç•™è¨€
    list.addEventListener("click", async (e) => {
      if (e.target.classList.contains("delete-btn")) {
        const id = e.target.dataset.id;
        if (confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ ğŸ’”")) {
          try {
            await deleteDoc(docRef(db, "messages", id));
            loadMessages();
          } catch (error) {
            console.error('åˆ é™¤å¤±è´¥:', error);
            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
          }
        }
      }
    });

    // åˆ†é¡µæ§ä»¶
    nextPageBtn.addEventListener("click", () => {
      if (!isLoading && lastVisible) {
        loadMessages("next");
      }
    });

    prevPageBtn.addEventListener("click", () => {
      if (!isLoading && firstVisible) {
        loadMessages("prev");
      }
    });

    // æ•°æ®è¿ç§»ï¼šå°†æ—§æ•°æ®æ ‡è®°ä¸ºé—²èŠåŒº
    async function migrateOldData() {
      try {
        // æŸ¥æ‰¾æ²¡æœ‰categoryå­—æ®µçš„æ–‡æ¡£
        const q = query(messagesRef, limit(100));
        const snapshot = await getDocs(q);
        
        const batch = writeBatch(db);
        let needsUpdate = false;
        
        snapshot.forEach(doc => {
          const data = doc.data();
          if (!data.category) {
            batch.update(doc.ref, { category: 'chat' });
            needsUpdate = true;
          }
        });
        
        if (needsUpdate) {
          await batch.commit();
          console.log('æ—§æ•°æ®è¿ç§»å®Œæˆ');
        }
      } catch (error) {
        console.error('æ•°æ®è¿ç§»å¤±è´¥:', error);
      }
    }

    // å›è½¦é”®å‘é€ï¼ˆShift+Enteræ¢è¡Œï¼‰
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
      }
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', async () => {
      // å…ˆè¿›è¡Œæ•°æ®è¿ç§»
      await migrateOldData();
      // ç„¶ååŠ è½½æ¶ˆæ¯
      loadMessages();
    });
  </script>
</body>
</html>
